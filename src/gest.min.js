/* 
 * @name: gest.js
 * @description: gest.js is a webcam based gesture recognition library that helps developers make webpages more immersive
 * @version: 0.5.1
 * @author: Hadi Michael (http://hadi.io)
 * @acknowledgements: gest.js is an extension of work started by William Wu (https://github.com/wvvvw)
 * @license: MIT License
 */

 window.gest=function(e){"use strict";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var t,n,a,i,o={framerate:25,videoCompressionRate:4,sensitivity:80,skinFilter:!1,debug:{state:!1,canvas:null,context:null}},r=!1,s=!1,d=function(){function t(){return b.removeEventListener("DOMContentLoaded",document,t),b.removeEventListener("load",e,t),h()&&(r=!0),s&&r?e.gest.start():!1}return d.prototype._singletonInstance?d.prototype._singletonInstance:(d.prototype._singletonInstance=this,"complete"===document.readyState?t.call():(b.addEventListener("DOMContentLoaded",document,t),b.addEventListener("load",e,t)),!0)},c=function(e){var t=b.createCustomEvent("gest",document);t.direction=e.direction||null,t.up=e.up||!1,t.down=e.down||!1,t.left=e.left||!1,t.right=e.right||!1,t.error=e.error||null,b.fireEvent(t)},h=function(){return n=document.createElement("video"),a=document.createElement("canvas"),n.canPlayType&&a.getContext&&a.getContext("2d")&&navigator.getUserMedia?(n.width=300,n.height=225,n.setAttribute("style","visibility: hidden;"),document.body.appendChild(n),a.setAttribute("style","width: 300px; display: none;"),document.body.appendChild(a),i=a.getContext("2d"),!0):(u(0),!1)},u=function(e,t){var n;switch(e){case 0:n={code:e,message:"gest.js can't run in your browser :("};break;case 1:n={code:e,message:"gest.js could not start."};break;case 2:n={code:e,message:"gest.js has already started."};break;case 10:n={code:e,message:"DEEENIED! gest.js needs webcam access.",obj:t};break;case 11:n={code:e,message:"A constraint specified is not supported by the web-browser.",obj:t};break;case 12:n={code:e,message:"No media tracks of the type specified in the constraints are found.",obj:t};break;case 13:n={code:e,message:"Couldn't get access to webcam.",obj:t};break;default:n=null}o.debug.state&&console.error(n.message),c({error:n})},v=function(e,t){try{i.drawImage(n,0,0,e,t);var a=i.getImageData(0,0,e,t);o.skinFilter?g.get(l.apply(a),o.sensitivity,e,t):g.get(a,o.sensitivity,e,t)}catch(r){if("NS_ERROR_NOT_AVAILABLE"===r.name)return!1;throw r}},l={huemin:0,huemax:.1,satmin:.3,satmax:1,valmin:.4,valmax:1,rgb2hsv:function(e,t,n){e/=255,t/=255,n/=255;var a,i,o=Math.max(e,t,n),r=Math.min(e,t,n),s=o,d=o-r;if(i=0===o?0:d/o,o==r)a=0;else{switch(o){case e:a=(t-n)/d+(n>t?6:0);break;case t:a=(n-e)/d+2;break;case n:a=(e-t)/d+4}a/=6}return[a,i,s]},apply:function(e){for(var t=e.width*e.height,n=4*t,a=0,i=0;i<e.height;i++)for(var o=0;o<e.width;o++){n=o+i*e.width;var r=e.data[a],s=e.data[a+1],d=e.data[a+2],c=e.data[a+3],h=this.rgb2hsv(r,s,d);(h[0]>this.huemin&&h[0]<this.huemax||h[0]>.59&&h[0]<1)&&h[1]>this.satmin&&h[1]<this.satmax&&h[2]>this.valmin&&h[2]<this.valmax?(e[a]=r,e[a+1]=s,e[a+2]=d,e[a+3]=c):(e.data[a]=255,e.data[a+1]=255,e.data[a+2]=255,e.data[a+3]=0),a=4*n}return e}},g={priorFrame:!1,get:function(e,t,n,a){var r=i.createImageData(n,a),s=0,d=0,c=0;if(this.priorFrame!==!1)for(var h=r.width*r.height,u=4*h,v=768;(u-=4)>=0;){var l=Math.abs(e.data[u]-this.priorFrame.data[u])+Math.abs(e.data[u+1]-this.priorFrame.data[u+1])+Math.abs(e.data[u+2]-this.priorFrame.data[u+2]);l>v*Math.abs((t-100)/100)?(r.data[u]=255,r.data[u+1]=0,r.data[u+2]=0,r.data[u+3]=255,c+=1,s+=u/4%r.width,d+=Math.floor(u/4/r.height)):(r.data[u]=e.data[u],r.data[u+1]=e.data[u+1],r.data[u+2]=e.data[u+2],r.data[u+3]=e.data[u+3])}c>0&&(m.search({x:s,y:d,d:c}),o.debug.state&&o.debug.context.putImageData&&(o.debug.canvas.width=n,o.debug.canvas.height=a,o.debug.context.putImageData(r,0,0))),this.priorFrame=e}},m={prior:!1,filteringFactor:.9,filteredTotal:0,minTotalChange:300,minDirChange:2,longDirChange:7,state:0,search:function(e){var t={x:e.x/e.d,y:e.y/e.d,d:e.d};this.filteredTotal=this.filteringFactor*this.filteredTotal+(1-this.filteringFactor)*t.d;var n=t.d-this.filteredTotal,a=n>this.minTotalChange;switch(this.state){case 0:a&&(this.state=1,m.prior=t);break;case 1:this.state=2;var i=t.x-m.prior.x,o=t.y-m.prior.y,r=Math.abs(o)<Math.abs(i);i<-this.minDirChange&&r?c({direction:"Right",right:!0}):i>this.minDirChange&&r&&c({direction:"Left",left:!0}),o>this.minDirChange&&!r?c(Math.abs(o)>this.longDirChange?{direction:"Long down",down:!0}:{direction:"Down",down:!0}):o<-this.minDirChange&&!r&&c(Math.abs(o)>this.longDirChange?{direction:"Long up",up:!0}:{direction:"Up",up:!0});break;case 2:a||(this.state=0)}}},b={htmlEvents:{onload:1,onunload:1,onblur:1,onchange:1,onfocus:1,onreset:1,onselect:1,onsubmit:1,onabort:1,onkeydown:1,onkeypress:1,onkeyup:1,onclick:1,ondblclick:1,onmousedown:1,onmousemove:1,onmouseout:1,onmouseover:1,onmouseup:1},addEventListener:function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent&&this.htmlEvents["on"+e]?t.attachEvent("on"+e,n):t["on"+e]=n},removeEventListener:function(e,t,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent&&this.htmlEvents["on"+e]?t.detachEvent("on"+e,n):t["on"+e]=null},createCustomEvent:function(e,t){try{var n;return t.createEvent?(n=t.createEvent("Event"),n.initEvent(e,!0,!0)):t.createEventObject&&(n=t.createEventObject(),n.eventType=e),n.evntName=e,n.evntElement=t,n}catch(a){return console.error(a),!1}},fireEvent:function(e){try{e.evntElement.dispatchEvent?e.evntElement.dispatchEvent(e):e.evntElement.fireEvent&&this.htmlEvents["on"+e.evntName]?e.evntElement.fireEvent("on"+e.eventType,e):e.evntElement[e.evntName]?e.evntElement[e.evntName]():e.evntElement["on"+e.evntName]&&e.evntElement["on"+e.evntName]()}catch(t){console.error(t)}}};return d.prototype.start=function(){return s=!0,r?n&&(n.paused||n.ended||n.seeking||n.readyState<n.HAVE_FUTURE_DATA)?(navigator.getUserMedia({audio:!1,video:!0},function(i){t=i,e.URL=e.URL||e.webkitURL,n.src=e.URL.createObjectURL(t),b.addEventListener("canplaythrough",n,function(){n.play(),b.addEventListener("playing",n,function(){var e=Math.floor(n.getBoundingClientRect().width/o.videoCompressionRate),t=Math.floor(n.getBoundingClientRect().height/o.videoCompressionRate);a.width=e,a.height=t,setInterval(function(){v(e,t)},1e3/o.framerate)})})},function(e){e.PERMISSION_DENIED||"PERMISSION_DENIED"===e.name?u(10,e):e.NOT_SUPPORTED_ERROR||"NOT_SUPPORTED_ERROR"===e.name?u(11,e):e.MANDATORY_UNSATISFIED_ERROR||"MANDATORY_UNSATISFIED_ERROR"===e.name?u(12,e):u(13,e)}),!!navigator.getUserMedia):(u(2),!1):!1},d.prototype.stop=function(){return r&&s?(n&&(n.src=""),t.getTracks()[0].stop(),!0):!1},d.prototype.options={subscribeWithCallback:function(e){e&&b.addEventListener("gest",document,function(t){e(t)})},sensitivity:function(e){e>=100?o.sensitivity=100:0>=e?o.sensitivity=0:o.sensitivity=e},debug:function(e){return o.debug.state=e,e?(o.debug.canvas=document.createElement("canvas"),o.debug.canvas.setAttribute("style","width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0;"),document.body.appendChild(o.debug.canvas),o.debug.context=o.debug.canvas.getContext("2d")):(o.debug.canvas.setAttribute("style","display: none;"),o.debug.canvas.parentNode.removeChild(o.debug.canvas)),o.debug},skinFilter:function(e){o.skinFilter=e}},new d}(window);